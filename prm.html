<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Матч-Арена. Футбольный манеж в Перми</title>

  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./book-modal.css" />
</head>

<body>

<!-- Выбор города -->
<div class="wrapper">
  <div class="dropdown">
    <a class="city-selection">Выбрать город</a>
    <div class="dropdown-child">
      <a href="./prm.html">Пермь</a>
      <a href="./ekb.html">Екатеринбург</a>
    </div>
  </div>
</div>

<header>
  <div class="logo">
    <a href="./"><img src="img/logo.png" alt="logo" /></a>
  </div>

  <nav class="menu">
    <ul>
      <li><a href="#about">О нас</a></li>
      <li><a href="#booking">Забронировать</a></li>
      <li><a href="#contacts">Контакты</a></li>
    </ul>
  </nav>
</header>

<main>

<h1>Футбольный манеж Матч-Арена</h1>

<section class="booking" id="booking">

<a class="self_book_btn" href="#open-modal">
  Забронировать
</a>

<div id="open-modal" class="modal-window">
  <div>
    <a href="#booking" class="modal-close">&#10006;</a>

    <h2>Бронирование</h2>

    <div id="booking-app">

      <label>Дата</label><br>
      <input type="date" id="date"><br><br>

      <label>Поле</label><br>
      <select id="hall">
        <option value="field-1">Поле №1</option>
        <option value="field-2">Поле №2</option>
      </select>

      <h3>Время</h3>
      <div id="slots"></div>

      <h3>Контакты</h3>
      <input placeholder="Имя" id="name"><br><br>
      <input placeholder="Телефон" id="phone"><br><br>

      <button class="submit_btn" id="book-btn">Забронировать</button>

    </div>
  </div>
</div>

</section>

<section id="contacts">
  <h2>Контакты</h2>
  <p>г. Пермь, ул. Героев Хасана, 105к71</p>
</section>

</main>

<footer>
  <p>Мы в соцсетях</p>
</footer>

<script src="./page-scripts.js"></script>

<script>
const API = "https://match-arena-booking-production.up.railway.app";
const TIMES = ["18:00","19:00","20:00","21:00"];

let bookingInited = false;
let selectedTime = null;

function initBookingIfNeeded() {
  if (bookingInited) return;

  const modal = document.getElementById("open-modal");
  if (!modal || !modal.offsetParent) return;

  const dateInput = modal.querySelector("#date");
  const hallSelect = modal.querySelector("#hall");
  const slotsDiv = modal.querySelector("#slots");
  const nameInput = modal.querySelector("#name");
  const phoneInput = modal.querySelector("#phone");
  const bookBtn = modal.querySelector("#book-btn");

  if (!dateInput || !hallSelect || !slotsDiv || !bookBtn) return;

  function loadSlots() {
    if (!dateInput.value) return;

    fetch(`${API}/availability?date=${dateInput.value}&hall=${hallSelect.value}`)
      .then(r => r.json())
      .then(booked => {
        slotsDiv.innerHTML = "";
        selectedTime = null;

        TIMES.forEach(time => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = time;
          btn.disabled = booked.includes(time);
          btn.onclick = () => {
            selectedTime = time;
            document.querySelectorAll("#slots button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          };
          slotsDiv.appendChild(btn);
        });
      });
  }

  dateInput.addEventListener("change", loadSlots);
  hallSelect.addEventListener("change", loadSlots);

  bookBtn.addEventListener("click", () => {
    if (!dateInput.value || !selectedTime || !nameInput.value || !phoneInput.value) {
      alert("Заполните все поля");
      return;
    }

    fetch(`${API}/booking`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        date: dateInput.value,
        time: selectedTime,
        hall: hallSelect.value,
        name: nameInput.value,
        phone: phoneInput.value
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert("Бронирование успешно!");
        loadSlots();
      } else {
        alert(data.error);
      }
    });
  });

  bookingInited = true;
}

setInterval(initBookingIfNeeded, 300);
</script>

</body>
</html>
